<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Add Job Posting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Theme stylesheet to match the main site visuals (light blue gradient, white cards, rounded UI) -->
    <link href="assets/theme.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card p-4 shadow-lg border-0 rounded-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="me-3 display-6 text-primary"><i class="bi bi-briefcase-fill"></i></div>
                        <div>
                            <h2 class="mb-0">Add New Job Posting</h2>
                            <small class="text-muted">Create job entries that candidates can analyze against their resumes.</small>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-7">
                            <form id="add-job-form">
                                <div class="mb-3">
                                    <label for="job-title" class="form-label">Job Title</label>
                                    <input type="text" class="form-control form-control-lg" id="job-title" required placeholder="e.g., Senior Python Developer">
                                </div>

                                <div class="mb-3">
                                    <label for="company" class="form-label">Company Name</label>
                                    <input type="text" class="form-control" id="company" required placeholder="e.g., Tech Solutions Inc.">
                                </div>

                                <div class="mb-3">
                                    <label for="full-description" class="form-label">Full Job Description</label>
                                    <textarea class="form-control" id="full-description" rows="8" required placeholder="Paste the entire job description here..."></textarea>
                                    <div class="form-text"><span id="desc-words">0</span> words · <span id="desc-chars">0</span> chars</div>
                                </div>

                                <div class="d-grid">
                                    <button id="save-job-btn" type="submit" class="btn btn-primary btn-lg">
                                        <span id="save-spinner" class="spinner-border spinner-border-sm me-2" role="status" style="display:none"></span>
                                        Save Job to Database
                                    </button>
                                </div>

                                <div id="status-message" class="mt-3"></div>
                            </form>
                        </div>

                        <div class="col-lg-5">
                            <div class="card border-0 bg-light p-3">
                                <h5 class="mb-2">Preview</h5>
                                <div id="preview-panel" class="small text-muted">
                                    <p class="mb-1"><strong>Title:</strong> <span id="prev-title">—</span></p>
                                    <p class="mb-1"><strong>Company:</strong> <span id="prev-company">—</span></p>
                                    <div style="max-height:260px; overflow:auto; background:#fff; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.05);">
                                        <div id="prev-desc">No description yet. Paste a job description to preview.</div>
                                    </div>
                                </div>

                                <hr>
                                <div>
                                    <h6 class="mb-2">Helpful tips</h6>
                                    <ul class="small mb-0">
                                        <li>Include key responsibilities and required skills.</li>
                                        <li>Long descriptions are fine — candidates will be scored against them.</li>
                                        <li>Use consistent job titles to improve searchability.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://localhost:3000/api";

        const form = document.getElementById('add-job-form');
        const statusMessage = document.getElementById('status-message');
        const saveBtn = document.getElementById('save-job-btn');
        const spinner = document.getElementById('save-spinner');

        // live preview and counters
        const titleEl = document.getElementById('job-title');
        const companyEl = document.getElementById('company');
        const descEl = document.getElementById('full-description');
        const prevTitle = document.getElementById('prev-title');
        const prevCompany = document.getElementById('prev-company');
        const prevDesc = document.getElementById('prev-desc');
        const descWords = document.getElementById('desc-words');
        const descChars = document.getElementById('desc-chars');

        function updatePreview() {
            prevTitle.textContent = titleEl.value || '—';
            prevCompany.textContent = companyEl.value || '—';
            prevDesc.textContent = descEl.value ? descEl.value.substring(0, 800) : 'No description yet. Paste a job description to preview.';
            const words = descEl.value.trim() ? descEl.value.trim().split(/\s+/).length : 0;
            descWords.textContent = words;
            descChars.textContent = descEl.value.length;
        }

        [titleEl, companyEl, descEl].forEach(el => el && el.addEventListener('input', updatePreview));

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            statusMessage.innerHTML = '';
            spinner.style.display = 'inline-block';
            saveBtn.disabled = true;

            const jobTitle = titleEl.value.trim();
            const company = companyEl.value.trim();
            const fullDescription = descEl.value.trim();

            try {
                const response = await fetch(`${API_BASE_URL}/jobs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_title: jobTitle, company: company, full_description: fullDescription })
                });

                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    throw new Error(data.message || 'An unknown error occurred.');
                }

                statusMessage.innerHTML = '<div class="alert alert-success py-2">✅ Job saved successfully!</div>';
                form.reset();
                updatePreview();

            } catch (error) {
                statusMessage.innerHTML = `<div class="alert alert-danger py-2">❌ Error: ${error.message}</div>`;
            } finally {
                spinner.style.display = 'none';
                saveBtn.disabled = false;
            }
        });

        // initialize preview counters
        updatePreview();
    </script>
</body>
</html>

